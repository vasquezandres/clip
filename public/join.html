<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Unirse — SOLUTECH CLIP v3.4</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="styles.css">
<style>.container{max-width:980px;margin:20px auto;padding:12px}textarea{min-height:180px}</style>
</head>
<body>
<div class="header">
  <div class="brand">
    <div class="logo">S</div>
    <h1>Unirse — SOLUTECH CLIP</h1>
  </div>
</div>

<div class="container">
  <div class="card">
    <div class="row" style="justify-content:space-between;margin-bottom:8px">
      <div class="status"><span id="dot" class="dot" style="background:#aaa"></span><span id="stxt">Desconectado</span></div>
      <div class="row">
        <input id="key" placeholder="Código de sala (ABC123)" style="width:200px">
        <button id="btnJoin" class="btn btn-red"><i class="fa-solid fa-right-to-bracket"></i> Unirse</button>
        <button id="btnLogout" class="btn btn-ghost" disabled><i class="fa-solid fa-right-from-bracket"></i> Cerrar sesión</button>
      </div>
    </div>

    <label>Texto</label>
    <textarea id="txt" placeholder="Esperando mensaje…"></textarea>

    <div class="row" style="margin-top:10px">
      <button id="copy" class="btn btn-ghost"><i class="fa-solid fa-copy"></i> Copiar</button>
      <button id="sendBack" class="btn btn-red"><i class="fa-solid fa-paper-plane"></i> Enviar</button>
      <button id="markRead" class="btn btn-ghost" style="display:none"><i class="fa-solid fa-check-double"></i> Marcar leído</button>
    </div>
  </div>
</div>

<div class="toast-wrap" id="toasts"></div>

<script>
const toasts = document.getElementById('toasts');
function showToast(msg, kind='info', timeout=2000){ const div = document.createElement('div'); div.className='toast ' + (kind==='success'?'success':kind==='error'?'error':''); div.innerHTML = `<i class="fa-solid ${kind==='success'?'fa-circle-check':kind==='error'?'fa-triangle-exclamation':'fa-circle-info'}"></i> ${msg}`; toasts.appendChild(div); setTimeout(()=> div.remove(), timeout); }

let ws=null, currentKey=null;
const dot=document.getElementById("dot"), stxt=document.getElementById("stxt");
function setStatus(ok){dot.style.background=ok?"#12b886":"#aaa";stxt.textContent=ok?"Conectado":"Desconectado";}
function wsUrlFor(key){const proto=location.protocol==="https:"?"wss":"ws";return `${proto}://${location.host}/ws?key=${encodeURIComponent(key)}`;}
function b64(buf){return btoa(String.fromCharCode(...new Uint8Array(buf)));}
function b64toU8(b){return Uint8Array.from(atob(b),c=>c.charCodeAt(0));}
async function deriveKeyFromRoom(roomKey){const enc=new TextEncoder();return crypto.subtle.importKey("raw",enc.encode(roomKey),"PBKDF2",false,["deriveKey"]);}
async function encryptWithRoomKey(roomKey,plain){const enc=new TextEncoder();const keyMat=await deriveKeyFromRoom(roomKey);const salt=crypto.getRandomValues(new Uint8Array(16));const key=await crypto.subtle.deriveKey({name:"PBKDF2",salt,iterations:100000,hash:"SHA-256"},keyMat,{name:"AES-GCM",length:256},false,["encrypt"]);const iv=crypto.getRandomValues(new Uint8Array(12));const ct=await crypto.subtle.encrypt({name:"AES-GCM",iv},key,enc.encode(plain));return {cipher:b64(ct),iv:b64(iv),salt:b64(salt),alg:"AES-256-GCM",kdf:"PBKDF2-SHA256",iter:100000};}
async function decryptWithRoomKey(roomKey,payload){const {cipher,iv,salt}=payload;const keyMat=await deriveKeyFromRoom(roomKey);const key=await crypto.subtle.deriveKey({name:"PBKDF2",salt:b64toU8(salt),iterations:100000,hash:"SHA-256"},keyMat,{name:"AES-GCM",length:256},false,["decrypt"]);const pt=await crypto.subtle.decrypt({name:"AES-GCM",iv:b64toU8(iv)},key,b64toU8(cipher));return new TextDecoder().decode(pt);}
function connect(key){if(ws)try{ws.close();}catch{};ws=new WebSocket(wsUrlFor(key));ws.onopen=()=>{setStatus(true);document.getElementById("btnLogout").disabled=false;showToast('Conectado','success');};ws.onclose=()=>{setStatus(false);document.getElementById("btnLogout").disabled=true;showToast('Desconectado');};ws.onmessage=async (ev)=>{const msg=JSON.parse(ev.data);if(msg.type==="joined"){document.getElementById("markRead").style.display=msg.singleUse?"inline-block":"none";}if(msg.type==="new-e2e"){try{const plain=await decryptWithRoomKey(currentKey,msg.payload.data);const envelope=JSON.parse(plain);if(envelope.kind==="text"){document.getElementById("txt").value=envelope.text||"";showToast('Texto recibido','success');}else if(envelope.kind==="file"){const a=document.createElement("a");a.href=`data:${envelope.mime};base64,${envelope.dataBase64}`;a.download=envelope.name||"archivo";a.textContent=`Descargar adjunto: ${envelope.name} (${envelope.mime})`;a.style.display="inline-block";a.style.marginTop="6px";document.querySelector(".card").appendChild(a);showToast('Archivo recibido','success');}}catch{document.getElementById("txt").value="(No se pudo descifrar con esta clave)";showToast('No se pudo descifrar','error');}}};}
const qp=new URLSearchParams(location.search);if(qp.get("key")){currentKey=qp.get("key").toUpperCase();document.getElementById("key").value=currentKey;connect(currentKey);}
document.getElementById("btnJoin").onclick=()=>{const k=(document.getElementById("key").value||"").trim().toUpperCase();if(!k){showToast('Introduce la clave','error');return;}currentKey=k;connect(k);};
document.getElementById("btnLogout").onclick=()=>{try{ws&&ws.close();}catch{}};
document.getElementById("copy").onclick=async ()=>{const t=document.getElementById("txt").value||"";await navigator.clipboard.writeText(t);showToast('Copiado','success');};
document.getElementById("sendBack").onclick=async ()=>{if(!ws||ws.readyState!==1){showToast('No hay conexión','error');return;}const envelope=JSON.stringify({kind:"text",text:document.getElementById("txt").value});const encrypted=await encryptWithRoomKey(currentKey,envelope);ws.send(JSON.stringify({type:"send-e2e",payload:{kind:"text",data:encrypted}}));showToast('Enviado','success');};
document.getElementById("markRead").onclick=()=>{if(!ws)return;ws.send(JSON.stringify({type:"read"}));};
</script>
</body>
</html>
