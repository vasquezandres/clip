<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Unirse — SOLUTECH CLIP v3.3</title>
<style>
:root{--bg:#f6f7f9;--card:#ffffff;--ink:#101114;--muted:#6a6f7a;--line:#e8eaef;--red:#e10600;--chip:#ffffff;}
@media (prefers-color-scheme: dark){:root{--bg:#0f1115;--card:#151821;--ink:#f4f6fb;--muted:#9aa3b2;--line:#262a36;--chip:#1b1f2b;}}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.4 system-ui,Segoe UI,Roboto,Arial}
.container{max-width:980px;margin:20px auto;padding:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 28px rgba(0,0,0,.05);padding:14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.status{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:var(--chip);font-weight:600;color:var(--muted)}
.dot{width:10px;height:10px;border-radius:50%}
textarea{width:100%;min-height:160px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:transparent;color:var(--ink);font-family:ui-monospace,Menlo,Consolas,monospace}
input[type="text"]{padding:10px;border-radius:12px;border:1px solid var(--line);background:transparent;color:var(--ink)}
.btn{appearance:none;border:0;outline:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
.btn-red{background:var(--red);color:#fff}
.btn-ghost{background:transparent;border:1px solid var(--line);color:var(--ink)}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="row" style="justify-content:space-between;margin-bottom:8px">
      <div style="font-weight:800">Unirse a sesión — SOLUTECH CLIP</div>
      <div class="status"><span id="dot" class="dot" style="background:#aaa"></span><span id="stxt">Desconectado</span></div>
    </div>
    <div class="row">
      <input id="key" placeholder="Código de sala (ABC123)" style="width:200px">
      <button id="btnJoin" class="btn btn-red">Unirse</button>
      <button id="btnLogout" class="btn btn-ghost" disabled>Cerrar sesión</button>
    </div>
    <p id="status" style="color:var(--muted)"></p>
    <label>Texto</label>
    <textarea id="txt" placeholder="Esperando mensaje…"></textarea>
    <div class="row" style="margin-top:10px">
      <button id="copy" class="btn btn-ghost">Copiar</button>
      <button id="sendBack" class="btn btn-red">Enviar</button>
      <button id="markRead" class="btn btn-ghost" style="display:none">Marcar leído (single-use)</button>
    </div>
  </div>
</div>
<script>
let ws=null, currentKey=null;
const dot=document.getElementById("dot"), stxt=document.getElementById("stxt");
function setStatus(ok){dot.style.background=ok?"#12b886":"#aaa";stxt.textContent=ok?"Conectado":"Desconectado";}
function wsUrlFor(key){const proto=location.protocol==="https:"?"wss":"ws";return `${proto}://${location.host}/ws?key=${encodeURIComponent(key)}`;}
function b64(buf){return btoa(String.fromCharCode(...new Uint8Array(buf)));}
function b64toU8(b){return Uint8Array.from(atob(b),c=>c.charCodeAt(0));}
async function deriveKeyFromRoom(roomKey){const enc=new TextEncoder();return crypto.subtle.importKey("raw",enc.encode(roomKey),"PBKDF2",false,["deriveKey"]);}
async function encryptWithRoomKey(roomKey,plain){const enc=new TextEncoder();const keyMat=await deriveKeyFromRoom(roomKey);const salt=crypto.getRandomValues(new Uint8Array(16));const key=await crypto.subtle.deriveKey({name:"PBKDF2",salt,iterations:100000,hash:"SHA-256"},keyMat,{name:"AES-GCM",length:256},false,["encrypt"]);const iv=crypto.getRandomValues(new Uint8Array(12));const ct=await crypto.subtle.encrypt({name:"AES-GCM",iv},key,enc.encode(plain));return {cipher:b64(ct),iv:b64(iv),salt:b64(salt),algo:"aes-gcm-pbkdf2-v1"};}
async function decryptWithRoomKey(roomKey,payload){const {cipher,iv,salt}=payload;const keyMat=await deriveKeyFromRoom(roomKey);const key=await crypto.subtle.deriveKey({name:"PBKDF2",salt:b64toU8(salt),iterations:100000,hash:"SHA-256"},keyMat,{name:"AES-GCM",length:256},false,["decrypt"]);const pt=await crypto.subtle.decrypt({name:"AES-GCM",iv:b64toU8(iv)},key,b64toU8(cipher));return new TextDecoder().decode(pt);}
function connect(key){if(ws)try{ws.close();}catch{};ws=new WebSocket(wsUrlFor(key));ws.onopen=()=>{setStatus(true);document.getElementById("btnLogout").disabled=false;};ws.onclose=()=>{setStatus(false);document.getElementById("btnLogout").disabled=true;};ws.onmessage=async (ev)=>{const msg=JSON.parse(ev.data);const status=document.getElementById("status");if(msg.type==="joined"){status.textContent=`Conectado. Expira: ${new Date(msg.expiresAt).toLocaleString()} • singleUse=${msg.singleUse}`;document.getElementById("markRead").style.display=msg.singleUse?"inline-block":"none";}if(msg.type==="new-e2e"){try{const plain=await decryptWithRoomKey(currentKey,msg.payload.data);const envelope=JSON.parse(plain);if(envelope.kind==="text"){document.getElementById("txt").value=envelope.text||"";}else if(envelope.kind==="file"){const a=document.createElement("a");a.href=`data:${envelope.mime};base64,${envelope.dataBase64}`;a.download=envelope.name||"archivo";a.textContent=`Descargar adjunto: ${envelope.name} (${envelope.mime})`;a.style.display="inline-block";a.style.marginTop="6px";document.querySelector(".card").appendChild(a);} }catch{document.getElementById("txt").value="(No se pudo descifrar el contenido con esta clave)";}}if(msg.type==="session-destroyed"){alert("Sesión eliminada.");status.textContent="Sesión eliminada.";ws.close();}if(msg.type==="error"){alert("Error: "+msg.error);status.textContent="Error: "+msg.error;ws.close();}};}
const qp=new URLSearchParams(location.search);if(qp.get("key")){currentKey=qp.get("key").toUpperCase();document.getElementById("key").value=currentKey;connect(currentKey);}
document.getElementById("btnJoin").onclick=()=>{const k=(document.getElementById("key").value||"").trim().toUpperCase();if(!k)return alert("Introduce la clave.");currentKey=k;connect(k);};
document.getElementById("btnLogout").onclick=()=>{try{ws&&ws.close();}catch{}};
document.getElementById("copy").onclick=async ()=>{const t=document.getElementById("txt").value||"";await navigator.clipboard.writeText(t);alert("Copiado");};
document.getElementById("sendBack").onclick=async ()=>{if(!ws||ws.readyState!==1)return alert("No hay conexión.");const envelope=JSON.stringify({kind:"text",text:document.getElementById("txt").value});const encrypted=await encryptWithRoomKey(currentKey,envelope);ws.send(JSON.stringify({type:"send-e2e",payload:{kind:"text",data:encrypted}}));};
document.getElementById("markRead").onclick=()=>{if(!ws)return;ws.send(JSON.stringify({type:"read"}));};
</script>
</body>
</html>
