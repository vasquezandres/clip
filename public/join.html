<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Unirse — SOLUTECH CLIP</title>
<style>
:root{--bg:#f6f7f9;--card:#ffffff;--ink:#101114;--muted:#6a6f7a;--line:#e8eaef;--red:#e10600;--chip:#ffffff;}
@media (prefers-color-scheme: dark){:root{--bg:#0f1115;--card:#151821;--ink:#f4f6fb;--muted:#9aa3b2;--line:#262a36;--chip:#1b1f2b;}}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.4 system-ui,Segoe UI,Roboto,Arial}
.container{max-width:980px;margin:20px auto;padding:12px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 28px rgba(0,0,0,.05);padding:14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.status{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:var(--chip);font-weight:600;color:var(--muted)}
.dot{width:10px;height:10px;border-radius:50%}
textarea{width:100%;min-height:160px;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:transparent;color:var(--ink);font-family:ui-monospace,Menlo,Consolas,monospace}
input[type="text"],input[type="password"]{padding:10px;border-radius:12px;border:1px solid var(--line);background:transparent;color:var(--ink)}
.btn{appearance:none;border:0;outline:0;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
.btn-red{background:var(--red);color:#fff}
.btn-ghost{background:transparent;border:1px solid var(--line);color:var(--ink)}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="row" style="justify-content:space-between;margin-bottom:8px">
      <div style="font-weight:800">Unirse a sesión — SOLUTECH CLIP</div>
      <div class="status"><span id="dot" class="dot" style="background:#aaa"></span><span id="stxt">Desconectado</span></div>
    </div>
    <div class="row">
      <input id="key" placeholder="Código (ABC123)" style="width:180px">
      <input id="e2ePass" placeholder="Clave E2E (si aplica)" type="password" style="width:200px">
      <button id="btnJoin" class="btn btn-red">Unirse</button>
      <button id="btnLogout" class="btn btn-ghost" disabled>Cerrar sesión</button>
    </div>
    <p id="status" style="color:var(--muted)"></p>
    <label>Texto</label>
    <textarea id="txt" placeholder="Esperando mensaje…"></textarea>
    <div class="row" style="margin-top:10px">
      <button id="copy" class="btn btn-ghost">Copiar</button>
      <button id="sendBack" class="btn btn-red">Enviar</button>
      <button id="markRead" class="btn btn-ghost" style="display:none">Marcar leído (single-use)</button>
    </div>
  </div>
</div>
<script>
let ws=null;
const dot=document.getElementById("dot"), stxt=document.getElementById("stxt");
function setStatus(ok){dot.style.background=ok?"#12b886":"#aaa";stxt.textContent=ok?"Conectado":"Desconectado";}
function wsUrlFor(key){const proto=location.protocol==="https:"?"wss":"ws";return `${proto}://${location.host}/ws?key=${encodeURIComponent(key)}`;}
// E2E helpers
function b64toU8(b){return Uint8Array.from(atob(b),c=>c.charCodeAt(0));}
async function importKeyFromSalt(pass,salt){const enc=new TextEncoder();const keyMaterial=await crypto.subtle.importKey("raw",enc.encode(pass),"PBKDF2",false,["deriveKey"]);const key=await crypto.subtle.deriveKey({name:"PBKDF2",salt,iterations:100000,hash:"SHA-256"},keyMaterial,{name:"AES-GCM",length:256},false,["decrypt"]);return key;}
async function e2eDecrypt(payload,pass){const {cipher,iv,salt}=payload;const key=await importKeyFromSalt(pass,b64toU8(salt));const pt=await crypto.subtle.decrypt({name:"AES-GCM",iv:b64toU8(iv)},key,b64toU8(cipher));return new TextDecoder().decode(pt);}
function connect(key){if(ws)try{ws.close();}catch{};ws=new WebSocket(wsUrlFor(key));ws.onopen=()=>{setStatus(true);document.getElementById("btnLogout").disabled=false;};ws.onclose=()=>{setStatus(false);document.getElementById("btnLogout").disabled=true;};ws.onmessage=async (ev)=>{const msg=JSON.parse(ev.data);const status=document.getElementById("status");if(msg.type==="joined"){document.getElementById("txt").value=msg.lastText||(msg.lastText==="(e2e)"?"(cifrado)":"");status.textContent=`Conectado. Expira: ${new Date(msg.expiresAt).toLocaleString()}`;document.getElementById("markRead").style.display=msg.singleUse?"inline-block":"none";}if(msg.type==="new-text"){document.getElementById("txt").value=msg.text||"";}if(msg.type==="new-text-e2e"){const pass=document.getElementById("e2ePass").value;if(!pass){document.getElementById("txt").value="(Contenido cifrado: ingresa la clave E2E)";return;}try{const plain=await e2eDecrypt(msg.payload,pass);document.getElementById("txt").value=plain;}catch{document.getElementById("txt").value="(No se pudo descifrar — clave E2E incorrecta)";}}if(msg.type==="new-file"){const {name,mime="application/octet-stream",dataBase64}=msg.file||{};const a=document.createElement("a");a.href=`data:${mime};base64,${dataBase64}`;a.download=name||"archivo";a.textContent=`Descargar adjunto: ${name} (${mime})`;a.style.display="inline-block";a.style.marginTop="6px";document.querySelector(".card").appendChild(a);}if(msg.type==="session-destroyed"){alert("Sesión eliminada.");status.textContent="Sesión eliminada.";ws.close();}if(msg.type==="error"){alert("Error: "+msg.error);status.textContent="Error: "+msg.error;ws.close();}};}
// Auto-join
const qp=new URLSearchParams(location.search);
if(qp.get("key")){document.getElementById("key").value=qp.get("key").toUpperCase();connect(qp.get("key").toUpperCase());}
document.getElementById("btnJoin").onclick=()=>{const k=(document.getElementById("key").value||"").trim().toUpperCase();if(!k)return alert("Introduce la clave.");connect(k);};
document.getElementById("btnLogout").onclick=()=>{try{ws&&ws.close();}catch{}};
document.getElementById("copy").onclick=async ()=>{const t=document.getElementById("txt").value||"";await navigator.clipboard.writeText(t);alert("Copiado");};
document.getElementById("sendBack").onclick=()=>{if(!ws||ws.readyState!==1)return alert("No hay conexión.");ws.send(JSON.stringify({type:"send-text",text:document.getElementById('txt').value}));};
document.getElementById("markRead").onclick=()=>{if(!ws)return;ws.send(JSON.stringify({type:"read"}));};
</script>
</body>
</html>
