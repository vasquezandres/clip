<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SOLUTECH CLIP — v3.5</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="styles.css">
<link rel="icon" href="favicon.ico">
<style>
  /* --- Estilos mínimos para la pantalla inicial --- */
  .landing {
    max-width: 640px; margin: 40px auto; padding: 20px;
    background: var(--card); border-radius: 16px; box-shadow: var(--shadow-md);
  }
  .landing h1 { display:flex; gap:10px; align-items:center; margin:0 0 12px 0; }
  .landing .actions { display:flex; gap:10px; flex-wrap:wrap; }
  .landing .hint { color:var(--muted); font-size:12px; margin-top:6px }
  .hidden { display:none !important; }
  .bigbtn { padding:12px 16px; font-size:16px; border-radius:12px; }
  .input-fat { height:44px; border-radius:12px; padding:0 12px; width:100%; }
  .topbar { display:flex; justify-content:space-between; align-items:center; margin:12px auto; max-width:1100px; padding:0 8px; }
</style>
</head>
<body>

<!-- ╭────────────────────────── TOP BAR ──────────────────────────╮ -->
<div class="topbar">
  <div class="brand" style="display:flex; gap:10px; align-items:center">
    <div class="logo">S</div>
    <strong>SOLUTECH CLIP — v3.5</strong>
  </div>
  <button id="themeToggle" class="btn btn-chip" title="Cambiar tema"><i class="fa-solid fa-moon"></i></button>
</div>
<!-- ╰────────────────────────── TOP BAR ──────────────────────────╯ -->

<!-- ╭────────────────────────── LANDING MINIMAL ──────────────────╮ -->
<section id="landing" class="landing">
  <h1>
    <span class="logo">S</span> Inicio rápido
  </h1>
  <p class="hint">
    Ingresa una <b>clave de sala</b> si quieres usar una propia. Si la dejas vacía, se generará automáticamente.
  </p>
  <div style="display:flex; gap:10px; flex-wrap:wrap; margin:10px 0">
    <input id="landingKey" class="input-fat field" placeholder="Clave personalizada (opcional, ej. ABC123)" maxlength="16" />
  </div>
  <div class="actions">
    <button id="btnLandingCreate" class="btn btn-red bigbtn">
      <i class="fa-solid fa-plus"></i> Crear
    </button>
    <button id="btnLandingJoin" class="btn btn-ghost bigbtn">
      <i class="fa-solid fa-right-to-bracket"></i> Unirse
    </button>
  </div>
  <div class="hint">Por defecto: expira en <b>5 minutos</b> y <b>se destruye al leer</b> (single-use).</div>
</section>
<!-- ╰────────────────────────── LANDING MINIMAL ──────────────────╯ -->

<!-- ╭────────────────────────── APP COMPLETA ──────────────────────╮ -->
<div id="app" class="container hidden">
  <div class="grid">
    <!-- Panel principal -->
    <div class="card" id="card-main">
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <span class="status"><span id="dot" class="dot" style="background:#aaa"></span><span id="stxt">Sin sesión</span></span>
        <div class="row">
          <input id="joinCode" class="input-pill field" placeholder="Código de sala (ABC123)" maxlength="16">
          <button id="btnJoinFromMain" class="btn btn-ghost"><i class="fa-solid fa-right-to-bracket"></i> Unirse</button>
          <button id="btnLogout" class="btn btn-ghost" disabled><i class="fa-solid fa-right-from-bracket"></i> Cerrar sesión</button>
        </div>
      </div>

      <label>Texto</label>
      <textarea id="txt" placeholder="(Opcional) Pega aquí el texto que desees enviar…"></textarea>

      <div class="row" style="gap:8px; flex-wrap:wrap; margin:8px 0">
        <input id="customKey" class="input-pill field" placeholder="Clave manual (opcional)" maxlength="16">
        <small class="help">Si la dejas vacía, se genera automáticamente.</small>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="btnCreate" class="btn btn-red"><i class="fa-solid fa-paper-plane"></i> Crear & Enviar</button>
        <button id="btnUpdate" class="btn btn-ghost" disabled><i class="fa-solid fa-rotate-right"></i> Reenviar</button>
        <button id="btnCopy" class="btn btn-ghost"><i class="fa-solid fa-copy"></i> Copiar</button>
      </div>

      <!-- Opciones avanzadas (fijas por defecto: 5 min + single-use) -->
      <details class="disclosure" style="margin-top:10px">
        <summary><i class="fa-solid fa-sliders"></i> Opciones avanzadas</summary>
        <div class="content">
          <div class="row" style="margin-bottom:8px">
            <label><input type="checkbox" id="singleUse" checked> Single-use (se destruye al leer)</label>
            <label>Expira
              <select id="ttl" class="input-pill">
                <option value="300" selected>5 min</option>
                <option value="900">15 min</option>
                <option value="1800">30 min</option>
                <option value="3600">1 hora</option>
              </select>
            </label>
          </div>
          <hr class="sep">
          <div class="row">
            <div class="filebox" style="flex:1">
              <input type="file" id="fileInput" accept=".txt,.json">
              <label for="fileInput"><i class="fa-solid fa-paperclip"></i> Adjuntar (.txt/.json)</label>
            </div>
            <label>Límite adjunto (KB):
              <input id="fileLimit" class="input-pill" type="number" min="10" max="200" value="150" style="width:90px">
            </label>
            <button id="btnSendFile" class="btn btn-ghost"><i class="fa-solid fa-file-arrow-up"></i> Enviar archivo</button>
          </div>
        </div>
      </details>

      <hr class="sep">
      <div id="result" style="margin-top:6px"></div>
    </div>

    <!-- Panel lateral -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Sesiones recientes</strong>
        <button id="btnClearHist" class="btn btn-chip"><i class="fa-solid fa-broom"></i> Limpiar</button>
      </div>
      <div id="history" class="history" style="margin-top:8px"></div>
      <hr class="sep">
      <div><strong>Datos de la sesión</strong></div>
      <div id="sessionInfo" style="font-family:ui-monospace,Menlo,Consolas,monospace;color:var(--muted);font-size:12px;margin-top:6px">—</div>
    </div>
  </div>

  <div class="footer">
    <div style="margin:6px 0">© 2025 Solutech Panamá — Cloudflare Workers + Durable Objects</div>
    <div>Soluciones reales a problemas tecnológicos • <a href="https://www.solutechpanama.com" target="_blank">Solutech Panamá</a> • <a href="https://wa.me/50768886778" target="_blank">WhatsApp Soporte</a></div>
  </div>
</div>
<!-- ╰────────────────────────── APP COMPLETA ──────────────────────╯ -->

<div class="toast-wrap" id="toasts"></div>

<script>
/* ========= Tema claro/oscuro ========= */
const root=document.documentElement;
const themeBtn=document.getElementById('themeToggle');
function applyTheme(mode){
  root.className=''; if(mode==='light') root.classList.add('light');
  localStorage.setItem('clip_theme_index',mode);
  themeBtn.innerHTML = mode==='light' ? '<i class="fa-solid fa-moon"></i>' : '<i class="fa-solid fa-sun"></i>';
  themeBtn.title = mode==='light' ? 'Cambiar a oscuro' : 'Cambiar a claro';
}
(function(){applyTheme(localStorage.getItem('clip_theme_index')||'light')})();
themeBtn.addEventListener('click',()=>{const cur=localStorage.getItem('clip_theme_index')||'light';applyTheme(cur==='light'?'dark':'light');});

/* ========= Toast ========= */
const toasts=document.getElementById('toasts');
function showToast(msg,kind='info',timeout=2200){
  const d=document.createElement('div');
  d.className='toast '+(kind==='success'?'success':kind==='error'?'error':'');
  d.innerHTML=`<i class="fa-solid ${kind==='success'?'fa-circle-check':kind==='error'?'fa-triangle-exclamation':'fa-circle-info'}"></i> ${msg}`;
  toasts.appendChild(d); setTimeout(()=>d.remove(),timeout);
}

/* ========= Estado / Historial ========= */
const dot=document.getElementById("dot"), stxt=document.getElementById("stxt"), result=document.getElementById("result"), sessionInfo=document.getElementById("sessionInfo"), historyBox=document.getElementById("history");
let ws=null, currentKey=null, expiresAt=0, lastJoinUrl=null;

function setStatus(ok){dot.style.background=ok?"#12b886":"#aaa";stxt.textContent=ok?`Conectado — ${currentKey}`:"Sin sesión";document.getElementById("btnLogout").disabled=!ok;document.getElementById("btnUpdate").disabled=!ok;}
function loadHistory(){const list=JSON.parse(localStorage.getItem("clip_history")||"[]");historyBox.innerHTML="";list.slice(0,8).forEach(it=>{const chip=document.createElement("div");chip.className="chip";chip.textContent=`${it.key} · ${new Date(it.when).toLocaleString()}`;chip.onclick=()=>window.open(it.joinUrl,"_blank");historyBox.appendChild(chip);});}
function saveHistory(key,joinUrl){const list=JSON.parse(localStorage.getItem("clip_history")||"[]");list.unshift({key,joinUrl,when:Date.now()});localStorage.setItem("clip_history",JSON.stringify(list.slice(0,12)));loadHistory();}
document.getElementById('btnClearHist').onclick=()=>{localStorage.removeItem('clip_history');loadHistory();showToast('Historial borrado','success');};

/* ========= QR (simple) ========= */
function qrFor(joinUrl){return `https://api.qrserver.com/v1/create-qr-code/?size=240x240&ecc=H&format=svg&margin=2&data=${encodeURIComponent(joinUrl)}`;}
function renderQR(joinUrl){const wrap=document.createElement('div'); wrap.className='qr-wrap'; const img=document.createElement('img'); img.alt='QR'; img.loading='lazy'; img.referrerPolicy='no-referrer'; img.src=qrFor(joinUrl); wrap.appendChild(img); return wrap;}

/* ========= WebSocket + E2E ========= */
function wsUrlFor(key){const proto=location.protocol==="https:"?"wss":"ws";return `${proto}://${location.host}/ws?key=${encodeURIComponent(key)}`;}
function b64(buf){return btoa(String.fromCharCode(...new Uint8Array(buf)));} 
function b64toU8(b){return Uint8Array.from(atob(b),c=>c.charCodeAt(0));}
async function deriveKeyFromRoom(roomKey){const enc=new TextEncoder();return crypto.subtle.importKey("raw",enc.encode(roomKey),"PBKDF2",false,["deriveKey"]);}
async function encryptWithRoomKey(roomKey,plain){
  const enc=new TextEncoder();
  const keyMat=await deriveKeyFromRoom(roomKey);
  const salt=crypto.getRandomValues(new Uint8Array(16));
  const key=await crypto.subtle.deriveKey({name:"PBKDF2",salt,iterations:100000,hash:"SHA-256"},keyMat,{name:"AES-GCM",length:256},false,["encrypt"]);
  const iv=crypto.getRandomValues(new Uint8Array(12));
  const ct=await crypto.subtle.encrypt({name:"AES-GCM",iv},key,enc.encode(plain));
  return {cipher:b64(ct),iv:b64(iv),salt:b64(salt),alg:"AES-GCM/PBKDF2"};
}
async function decryptWithRoomKey(roomKey,payload){
  const keyMat=await deriveKeyFromRoom(roomKey);
  const key=await crypto.subtle.deriveKey({name:"PBKDF2",salt:b64toU8(payload.salt),iterations:100000,hash:"SHA-256"},keyMat,{name:"AES-GCM",length:256},false,["decrypt"]);
  const pt=await crypto.subtle.decrypt({name:"AES-GCM",iv:b64toU8(payload.iv)},key,b64toU8(payload.cipher));
  return new TextDecoder().decode(pt);
}
function connectWS(key,onOpenSend){
  if(ws) try{ ws.close(); }catch{}
  ws=new WebSocket(wsUrlFor(key));
  ws.onopen=()=>{ setStatus(true); onOpenSend&&onOpenSend(); showToast('Conectado','success'); };
  ws.onclose=()=>{ setStatus(false); showToast('Desconectado'); };
  ws.onmessage=async (ev)=>{
    const msg=JSON.parse(ev.data);
    if(msg.type==="session-destroyed"){ showToast('Sesión eliminada (single-use)'); setStatus(false); currentKey=null; return; }
    if(msg.type==="error"){ showToast('Error: '+msg.error,'error'); return; }
    if(msg.type==="joined"){ sessionInfo.textContent=`exp=${new Date(msg.expiresAt).toLocaleString()} • singleUse=${msg.singleUse}`; }
    if(msg.type==="new-e2e"){
      try{
        const plain=await decryptWithRoomKey(currentKey,msg.payload.data);
        const env=JSON.parse(plain);
        if(env.kind==="text"){ document.getElementById("txt").value=env.text||""; showToast('Texto recibido','success'); }
        if(env.kind==="file"){
          const a=document.createElement("a");
          a.href=`data:${env.mime};base64,${env.dataBase64}`;
          a.download=env.name||"archivo";
          a.textContent=`Descargar adjunto: ${env.name}`;
          a.style.display="inline-block"; a.style.marginTop="6px";
          result.prepend(a); showToast('Archivo recibido','success');
        }
      }catch{ document.getElementById("txt").value="(No se pudo descifrar el contenido con esta clave)"; showToast('No se pudo descifrar','error'); }
    }
  };
}

/* ========= Acciones del APP ========= */
async function createSession(ttl=300,single=true,customKey){
  const r=await fetch("/api/create",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({singleUse:single,ttlSeconds:ttl,customKey})});
  const data=await r.json();
  if(!data.ok){ showToast(data.error||'No se pudo crear la sesión','error'); return; }
  currentKey=data.key; expiresAt=data.expiresAt; lastJoinUrl=data.joinUrl;

  result.innerHTML="";
  result.appendChild(renderQR(lastJoinUrl));
  const tools=document.createElement('div'); tools.className='row'; tools.style.gap='6px'; tools.style.flexWrap='wrap';
  tools.innerHTML=`<a href="${lastJoinUrl}" target="_blank">${lastJoinUrl}</a>
    <button id="copyurl" class="btn btn-chip"><i class="fa-solid fa-link"></i> Copiar URL</button>
    <button id="copykey" class="btn btn-chip"><i class="fa-solid fa-key"></i> Copiar clave</button>
    <button id="openjoin" class="btn btn-chip"><i class="fa-solid fa-up-right-from-square"></i> Abrir join</button>
    <a class="btn btn-wa" target="_blank" href="https://wa.me/?text=${encodeURIComponent(lastJoinUrl)}"><i class="fa-brands fa-whatsapp"></i> WhatsApp</a>
    <small class="help">Expira: ${new Date(expiresAt).toLocaleString()}</small>`;
  result.appendChild(tools);
  document.getElementById("copyurl").onclick=()=>navigator.clipboard.writeText(lastJoinUrl).then(()=>showToast('URL copiada','success'));
  document.getElementById("copykey").onclick=()=>navigator.clipboard.writeText(currentKey).then(()=>showToast('Clave copiada','success'));
  document.getElementById("openjoin").onclick=()=>window.open(lastJoinUrl,"_blank");
  saveHistory(currentKey,lastJoinUrl);

  connectWS(currentKey, async ()=>{
    const text=document.getElementById("txt").value.trim();
    if(!text) return; // crear sin texto, como pediste
    const envelope=JSON.stringify({kind:"text",text});
    const encrypted=await encryptWithRoomKey(currentKey,envelope);
    const file_limit_kb=Number(document.getElementById("fileLimit").value||150);
    ws.send(JSON.stringify({type:"send-e2e",payload:{kind:"text",data:encrypted},file_limit_kb}));
    showToast('Enviado','success');
  });
}

function updateSend(){
  if(!ws||ws.readyState!==1){ showToast('No hay sesión activa','error'); return; }
  const text=document.getElementById("txt").value.trim();
  const send = async ()=>{
    const env=JSON.stringify({kind:"text",text});
    const enc=await encryptWithRoomKey(currentKey,env);
    const file_limit_kb=Number(document.getElementById("fileLimit").value||150);
    ws.send(JSON.stringify({type:"send-e2e",payload:{kind:"text",data:enc},file_limit_kb}));
    showToast('Reenviado','success');
  };
  if(!text){ showToast('Nada que enviar','error'); return; }
  send();
}

function sendFile(){
  if(!ws||ws.readyState!==1){ showToast('No hay sesión activa','error'); return; }
  const fi=document.getElementById("fileInput");
  if(!fi.files||!fi.files.length){ showToast('Selecciona un archivo','error'); return; }
  const f=fi.files[0];
  const limitKB=Number(document.getElementById("fileLimit").value||150);
  if(f.size>limitKB*1024){ showToast('Archivo excede el límite','error'); return; }
  (async ()=>{
    const arr=new Uint8Array(await f.arrayBuffer());
    const b64=btoa(String.fromCharCode(...arr));
    const env=JSON.stringify({kind:"file",name:f.name,mime:(f.type||"text/plain"),dataBase64:b64});
    const enc=await encryptWithRoomKey(currentKey,env);
    ws.send(JSON.stringify({type:"send-e2e",payload:{kind:"file",data:enc},file_limit_kb:limitKB}));
    showToast('Archivo enviado','success');
  })();
}

function logout(){ try{ws&&ws.close();}catch{}; ws=null; currentKey=null; lastJoinUrl=null; setStatus(false); sessionInfo.textContent="—"; showToast('Cerraste la sesión'); }
function joinFromMain(){ const code=(document.getElementById("joinCode").value||"").trim().toUpperCase(); if(!code){ showToast('Ingresa un código','error'); return; } currentKey=code; connectWS(code); }

document.getElementById("btnCreate").onclick=()=>createSession(parseInt(document.getElementById('ttl').value||'300',10),document.getElementById('singleUse').checked,(document.getElementById("customKey").value||"").trim()||undefined);
document.getElementById("btnUpdate").onclick=updateSend;
document.getElementById("btnCopy").onclick=()=>navigator.clipboard.writeText(document.getElementById("txt").value).then(()=>showToast('Texto copiado','success'));
document.getElementById("btnLogout").onclick=logout;
document.getElementById("btnJoinFromMain").onclick=joinFromMain;
document.getElementById("btnSendFile").onclick=sendFile;

/* ========= Lógica de LANDING ========= */
const landingEl=document.getElementById('landing');
const appEl=document.getElementById('app');
function showApp(){ landingEl.classList.add('hidden'); appEl.classList.remove('hidden'); loadHistory(); }

document.getElementById('btnLandingCreate').onclick=async ()=>{
  const raw=(document.getElementById('landingKey').value||'').trim().toUpperCase() || undefined;
  showApp();
  // Por defecto: 5 min, single-use ON
  await createSession(300,true,raw);
  // precarga el código en el campo del panel
  if(currentKey) document.getElementById('joinCode').value=currentKey;
  if(raw) document.getElementById('customKey').value=raw;
};

document.getElementById('btnLandingJoin').onclick=()=>{
  const raw=(document.getElementById('landingKey').value||'').trim().toUpperCase();
  if(!raw){ showToast('Ingresa la clave para unirte','error'); return; }
  showApp();
  document.getElementById('joinCode').value=raw;
  joinFromMain();
};

/* ========= Auto-join por ?key= (salta landing) ========= */
const qp=new URLSearchParams(location.search);
if(qp.get("key")){
  document.getElementById('landingKey').value=qp.get("key").toUpperCase();
  document.getElementById('btnLandingJoin').click();
}
</script>
</body>
</html>
